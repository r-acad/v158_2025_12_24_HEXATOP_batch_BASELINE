# FILE: .\configs\solver_settings.yaml
# ==============================================================================
# PART 2: NUMERICAL SOLVER & OPTIMIZATION SETTINGS
# ==============================================================================

# ------------------------------------------------------------------------------
# HARDWARE PROFILE
# ------------------------------------------------------------------------------
gpu_profile: "RTX" 

# ------------------------------------------------------------------------------
# RESTART CONFIGURATION
# ------------------------------------------------------------------------------
restart_configuration:
  enable_restart: false
  file_path: ""

# ------------------------------------------------------------------------------
# MESH & ADAPTIVITY SETTINGS
# ------------------------------------------------------------------------------
mesh_settings:
  initial_ground_mesh_size: 5_000_000
  final_target_of_active_elements: 90_000_000
  
  max_growth_rate: 1.1
  nominal_refinement_threshold: 0.9
  # CHANGE: Lower exponent allows mesh to grow faster earlier, capturing detail sooner.
  exponent_for_refinement_schedule: 1.0 
  max_background_elements: 800_000_000
  gpu_solver_safety_factor: 0.95

# ------------------------------------------------------------------------------
# OPTIMIZATION LOOP
# ------------------------------------------------------------------------------
# CHANGE: Increased iterations to allow the "annealing" phase (shrinking radius) to work.
number_of_iterations: 500
hard_stop_after_iteration: 550

optimization_parameters:
  density_update_method: "hard"
  min_density: 0.0001
  density_clamp_max: 1
  
  # CHANGE: Conservative culling protects thin, forming struts from being deleted.
  max_culling_ratio: 0.05   # Was 0.2 (Too aggressive for detailed structures)
  
  # Culling schedule
  final_density_threshold: 0.90
  exponent_for_cutoff_schedule: 1.5 

  # ----------------------------------------------------------------------------
  # FILTER RADIUS (CRITICAL FOR DETAIL)
  # ----------------------------------------------------------------------------
  minimum_feature_size_physical: 0.1
  
  # CHANGE: A floor of 1.0 is unstable (checkerboarding). 1.5 is the sweet spot for detail.
  minimum_feature_size_elements: 1.5 

  # CHANGE: Start with a wide filter (4x) to find global paths, end at 1x for fine detail.
  radius_max_multiplier: 4.0  # Was 1.0 (Static filter is bad for topology)
  radius_min_multiplier: 1.0  
  radius_decay_exponent: 1.5  # Controls how fast we shrink from 4.0 to 1.0
  
  constraint_constant: 0.25

# ------------------------------------------------------------------------------
# SOLVER PARAMETERS
# ------------------------------------------------------------------------------
solver_parameters:
  solver_type: gpu              
  preconditioner: "multigrid"
  # Note: For 60M elements on RTX, Multigrid might OOM. 
  # If it crashes, the code will auto-fallback to "jacobi", which is safer but slower.
  tolerance: 1.e-6 
  max_iterations: 30000 
  diagonal_shift_factor: 1.e-7 
  stagnation_tolerance: 1.0e-3
  max_shift_attempts: 7
  shift_multiplier: 10.0
  gpu_method: krylov        
  krylov_solver: cg              

# ------------------------------------------------------------------------------
# OUTPUT SETTINGS
# ------------------------------------------------------------------------------
output_settings:
  export_frequency: 1       
  save_bin_frequency: 5     # Reduced frequency to save disk space/time
  save_STL_frequency: 20    
  save_VTK_frequency: 1     
  save_principal_stress_vectors: no
  log_filename: simulation_log.txt
  iso_surface_threshold: 0.01
  
  # CHANGE: Subdivision 2 on 60M elements = ~billions of triangles (will crash slicers).
  # 0 or 1 is sufficient for very fine meshes.
  stl_subdivision_level: 0       
  stl_smoothing_passes: 1        
  stl_mesh_smoothing_iters: 3    
  maximum_cells_in_binary_output: 25_000_000
  stl_target_triangle_count: 500000 # Increased to handle complex detail